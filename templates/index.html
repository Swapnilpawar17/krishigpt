<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KrishiGPT - Retailer CRM Edition</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    :root { --green:#2f855a; --muted:#6b7280; --bg:#f7faf7; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background: var(--bg); }
    .container { max-width: 900px; margin: 0 auto; padding: 16px; }
    .card { background: #fff; border-radius: 10px; padding: 16px; box-shadow: 0 2px 10px rgba(0,0,0,.06); }
    h1 { margin: 0 0 8px 0; }
    .sub { color: var(--muted); margin: 0 0 16px 0; }
    
    /* Retailer Branding Section */
    .retailer-section { background: #f0fdf4; border-left: 4px solid var(--green); padding: 12px; margin-bottom: 15px; border-radius: 4px; }
    .retailer-header { display: flex; justify-content: space-between; align-items: center; }
    .retailer-title { font-weight: bold; color: #166534; font-size: 14px; }
    .retailer-toggle { color: var(--green); text-decoration: underline; cursor: pointer; font-size: 12px; background: none; border: none; padding: 0; }
    .retailer-form { display: none; margin-top: 10px; }
    .retailer-form.show { display: block; }
    .retailer-display { font-size: 13px; font-weight: bold; color: #15803d; margin-top: 5px; }

    /* Chat */
    #chat { max-height: 55vh; overflow: auto; padding: 8px; border: 1px solid #eee; border-radius: 8px; background:#fafafa; }
    .msg { padding: 10px 12px; margin: 8px 0; border-radius: 8px; white-space: pre-wrap; position: relative; }
    .user { background: #e8f0fe; text-align: right; }
    .bot { background: #e7f7e7; }
    
    /* WhatsApp Share Button */
    .share-btn { 
      display: inline-flex; align-items: center; gap: 5px;
      margin-top: 8px; padding: 6px 12px; 
      background: #25D366; color: white; 
      font-size: 12px; font-weight: bold; 
      border-radius: 20px; text-decoration: none; 
      border: none; cursor: pointer; 
    }
    .share-btn:hover { background: #1ebc57; }

    .row { display: flex; gap: 8px; margin-top: 12px; }
    input, select { flex: 1; padding: 10px; border-radius: 6px; border: 1px solid #ccc; font-size:14px; width:100%; box-sizing:border-box; }
    button { padding: 10px 14px; border: 0; border-radius: 6px; background: var(--green); color:#fff; cursor: pointer; white-space:nowrap; }
    button.secondary { background:#1f2937; }
    button:disabled { background:#9aa5b1; cursor:not-allowed; }
    .toolbar { display:flex; gap:8px; margin-bottom:10px; flex-wrap: wrap; }
    
    /* Modal */
    .modal { position: fixed; inset:0; background: rgba(0,0,0,.45); display:none; align-items: center; justify-content: center; padding: 16px; z-index:999; }
    .modal.show { display:flex; }
    .box { width: 100%; max-width: 600px; background:#fff; border-radius: 10px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,.2); overflow-y:auto; max-height:90vh; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid .full { grid-column: 1 / -1; }
    .hint { color: var(--muted); font-size: 12px; margin-top:4px; }
    .result { background:#f8fafc; border:1px solid #eee; border-radius:8px; padding:12px; margin-top:12px; }
    .close { background:#ef4444; }
    .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; }
    .footer { color:#6b7280; font-size:12px; margin-top:12px; text-align:center; }
    .hr { height:1px; background:#eee; margin: 12px 0; }
    label { font-weight:500; font-size:14px; display:block; margin-bottom:4px; }
    .top-actions { display:flex; gap:6px; justify-content:flex-end; margin-bottom:6px; }
    .top-actions button { padding:4px 8px; font-size:11px; }

    /* History List Styling */
    .hist-item { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .hist-item:last-child { border-bottom: none; }
    .hist-info { flex: 1; }
    .hist-name { font-weight: bold; color: #333; }
    .hist-prod { color: #666; font-size: 11px; }
    .hist-actions { display: flex; gap: 5px; }
    .btn-icon { padding: 4px 6px; font-size: 12px; border-radius: 4px; cursor: pointer; text-decoration: none; border:none; color:white; }
    .btn-wa { background: #25D366; }
    .btn-wa:hover { background: #1ebc57; }

    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üåæ KrishiGPT</h1>
      <p class="sub">AI ‡§ï‡•É‡§∑‡§ø ‡§∏‡§≤‡§æ‡§π + üßÆ ‡§°‡•ã‡§ú‡§º ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞ + CRM</p>

      <!-- RETAILER BRANDING SECTION -->
      <div class="retailer-section">
        <div class="retailer-header">
          <div>
            <div class="retailer-title">üè™ ‡§¶‡•Å‡§ï‡§æ‡§®‡§¶‡§æ‡§∞ ‡§∏‡•á‡§ü‡§ø‡§Ç‡§ó (Retailer Mode)</div>
            <div id="shopDisplay" class="retailer-display"></div>
          </div>
          <button class="retailer-toggle" onclick="toggleShopSettings()">‚öôÔ∏è Setup</button>
        </div>
        
        <div id="shopSettings" class="retailer-form">
          <div class="grid" style="grid-template-columns: 1fr; gap: 8px;">
            <input type="text" id="shopNameInput" placeholder="Enter Shop Name (e.g. Patil Krishi Seva)">
            <input type="text" id="shopPhoneInput" placeholder="Mobile Number (e.g. 98220xxxxx)">
            <button onclick="saveShopDetails()">Save Details</button>
          </div>
        </div>
      </div>

      <div class="toolbar">
        <button id="openCalcBtn">üßÆ Dosage Calculator</button>
      </div>

      <!-- CROP INFO SECTION -->
      <div style="margin-bottom:10px; padding:8px; border:1px solid #eee; border-radius:8px; background:#f9fafb;">
        <div style="font-size:13px; font-weight:600; margin-bottom:6px;">
          üå± ‡§´‡§∏‡§≤ ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä (Crop Info) ‚Äì optional but recommended
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <div style="flex:1; min-width:120px;">
            <label style="font-size:12px; font-weight:500;">‡§´‡§∏‡§≤ (Crop)</label>
            <select id="cropSelect" style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc;">
              <option value="">-- ‡§®‡§ø‡§µ‡§°‡§æ / Select --</option>
              <option value="grapes">‡§¶‡•ç‡§∞‡§æ‡§ï‡•ç‡§∑ (Grapes)</option>
              <option value="pomegranate">‡§°‡§æ‡§≥‡§ø‡§Ç‡§¨ (Pomegranate)</option>
              <option value="tomato">‡§ü‡•ã‡§Æ‡•Ö‡§ü‡•ã (Tomato)</option>
              <option value="onion">‡§ï‡§æ‡§Ç‡§¶‡§æ (Onion)</option>
              <option value="cotton">‡§ï‡§æ‡§™‡•Ç‡§∏ (Cotton)</option>
              <option value="soybean">‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§® (Soybean)</option>
              <option value="sugarcane">‡§ä‡§∏ (Sugarcane)</option>
              <option value="wheat">‡§ó‡§π‡•Ç (Wheat)</option>
            </select>
          </div>
          <div style="flex:1; min-width:140px;">
            <label style="font-size:12px; font-weight:500;">‡§™‡•á‡§∞‡§£‡•Ä ‡§§‡§æ‡§∞‡•Ä‡§ñ (Sowing Date)</label>
            <input id="sowingDate" type="date"
                   style="width:100%; padding:6px; border-radius:6px; border:1px solid #ccc;"/>
            <div style="font-size:11px; color:#6b7280; margin-top:2px;">
              Format: YYYY-MM-DD
            </div>
          </div>
        </div>
      </div>

      <div id="chat"></div>
      <div class="row">
        <input id="msg" placeholder="‡§Ö‡§™‡§®‡§æ ‡§∏‡§µ‡§æ‡§≤ ‡§≤‡§ø‡§ñ‡•á‡§Ç‚Ä¶ (e.g., ‡§¶‡•ç‡§∞‡§æ‡§ï‡•ç‡§∑‡§æ‡§≤‡§æ ‡§¶‡§æ‡§µ‡§£‡•ç‡§Ø‡§æ ‡§â‡§™‡§æ‡§Ø)"/>
        <button id="send">Send</button>
      </div>
      <div class="footer">
        ‚ö†Ô∏è ‡§°‡§ø‡§∏‡•ç‡§ï‡•ç‡§≤‡•á‡§Æ‡§∞: ‡§Ø‡§π ‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§∏‡§≤‡§æ‡§π ‡§π‡•à; ‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§≤‡•á‡§¨‡§≤/‡§®‡§ø‡§Ø‡§Æ ‡§¶‡•á‡§ñ‡•á‡§Ç‡•§ ‡§∏‡§Ç‡§¶‡•á‡§π ‡§Æ‡•á‡§Ç KVK/‡§ï‡•É‡§∑‡§ø ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§
      </div>
    </div>
  </div>

  <!-- MODAL: DOSAGE CALCULATOR + CRM -->
  <div id="calcModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="calcTitle">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <h3 id="calcTitle" style="margin:0;">üßÆ ‡§°‡•ã‡§ú‡§º ‡§ï‡•à‡§≤‡§ï‡•Å‡§≤‡•á‡§ü‡§∞</h3>
        <button id="closeCalcBtn" class="close">‚úï</button>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="full">
          <label>‡§∂‡•á‡§§‡§ï‡§∞‡•Ä ‡§®‡§æ‡§µ (Farmer Name) <span style="font-weight:normal;color:#888">(required for history)</span>
            <input id="c_farmer" placeholder="e.g., Pandurang Patil"/>
          </label>
        </div>
        <div class="full">
          <label>‡§´‡§∏‡§≤ / ‡§™‡•ç‡§≤‡•â‡§ü ‡§®‡•ã‡§ü‡•ç‡§∏ (Crop / Notes)</label>
          <input id="c_cropnote" placeholder="e.g., Cotton 1 acre, village name"/>
        </div>
        <div class="full">
          <label>‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§ï‡§æ ‡§®‡§æ‡§Æ (Product Name)</label>
          <input id="c_product" placeholder="e.g., Emamectin 5% SG"/>
        </div>
        <div>
          <label>‡§á‡§ï‡§æ‡§à (Unit)</label>
          <select id="c_unit">
            <option value="ml_per_l">ml per liter (ml/L)</option>
            <option value="g_per_l">g per liter (g/L)</option>
            <option value="ml_per_acre">ml per acre</option>
            <option value="g_per_acre">g per acre</option>
          </select>
          <div class="hint">‡§≤‡•á‡§¨‡§≤ ‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡§æ‡§∞ ‡§ö‡•Å‡§®‡•á‡§Ç</div>
        </div>
        <div>
          <label>‡§¶‡§∞ (Rate)</label>
          <input id="c_rate" type="number" step="any" placeholder="e.g., 0.5"/>
          <div class="hint">ml/L, g/L, ml/acre ‡§Ø‡§æ g/acre</div>
        </div>
        <div>
          <label>‡§ü‡•à‡§Ç‡§ï ‡§∏‡§æ‡§á‡§ú (Tank Size - L)</label>
          <input id="c_tank" type="number" step="any" placeholder="e.g., 15 or 200"/>
        </div>
        <div>
          <label>‡§∏‡•ç‡§™‡•ç‡§∞‡•á ‡§Æ‡§æ‡§§‡•ç‡§∞‡§æ (Spray Volume - L/acre)</label>
          <input id="c_spray" type="number" step="any" placeholder="e.g., 200"/>
        </div>
        <div>
          <label>‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ (Area - Acre)</label>
          <input id="c_area" type="number" step="any" value="1"/>
        </div>
        <div class="full" style="display:flex;justify-content:space-between;align-items:center;">
          <button id="calcBtn" style="width:100%">Calculate (‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç)</button>
        </div>

        <div class="full">
          <div id="calcOut" class="result" style="display:none;"></div>
        </div>
      </div>

      <!-- HISTORY / MINI-CRM SECTION -->
      <div class="hr"></div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0; color:#166534;">üìú Recent Customers (‡§ó‡•ç‡§∞‡§æ‡§π‡§ï ‡§≤‡§ø‡§∏‡•ç‡§ü)</h4>
        <button onclick="clearHistory()" style="font-size:11px; background:#ef4444; color:white; border:none; border-radius:4px; padding:2px 8px; cursor:pointer;">Clear</button>
      </div>
      
      <div id="historyList" style="max-height: 150px; overflow-y: auto; border:1px solid #eee; border-radius:6px; font-size:12px;">
        <!-- History items inserted via JS -->
      </div>

      <div class="footer">
        ‡§®‡•ã‡§ü: ‡§π‡§Æ‡•á‡§∂‡§æ ‡§â‡§§‡•ç‡§™‡§æ‡§¶ ‡§≤‡•á‡§¨‡§≤/‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§®‡§ø‡§Ø‡§Æ‡•ã‡§Ç ‡§ï‡§æ ‡§™‡§æ‡§≤‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ PHI/REI ‡§î‡§∞ PPE ‡§ú‡§º‡§∞‡•Ç‡§∞‡•Ä ‡§π‡•à‡•§
      </div>
    </div>
  </div>

  <script>
    const API_KEY = ""; 

    // --- RETAILER BRANDING ---
    document.addEventListener('DOMContentLoaded', function() {
        const savedName = localStorage.getItem('krishiShopName');
        const savedPhone = localStorage.getItem('krishiShopPhone');
        if (savedName) {
            document.getElementById('shopNameInput').value = savedName;
            document.getElementById('shopPhoneInput').value = savedPhone || '';
            updateShopDisplay(savedName, savedPhone);
        } else {
            document.getElementById('shopDisplay').textContent = 'Setup your shop details to brand messages.';
        }
        
        // Load History
        renderHistory();
    });

    function toggleShopSettings() {
        document.getElementById('shopSettings').classList.toggle('show');
    }

    function saveShopDetails() {
        const name = document.getElementById('shopNameInput').value.trim();
        const phone = document.getElementById('shopPhoneInput').value.trim();
        
        if (name) {
            localStorage.setItem('krishiShopName', name);
            localStorage.setItem('krishiShopPhone', phone);
            updateShopDisplay(name, phone);
            toggleShopSettings();
            alert('Shop details saved!');
        } else {
            alert('Please enter a shop name.');
        }
    }

    function updateShopDisplay(name, phone) {
        document.getElementById('shopDisplay').textContent = `üè™ ${name} ${phone ? '| üìû ' + phone : ''}`;
    }

    function createWhatsAppLink(adviceText) {
        const shopName = localStorage.getItem('krishiShopName') || "KrishiGPT Advisor";
        const shopPhone = localStorage.getItem('krishiShopPhone') || "";
        
        const message = `
*üè™ ${shopName}*
${shopPhone ? 'üìû ' + shopPhone : ''}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
*‡§∂‡•á‡§§‡§ï‡§±‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§∏‡§≤‡•ç‡§≤‡§æ (Advice):*

${adviceText}

‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚úÖ *Verified by KrishiGPT*
üíä _‡§¶‡§µ‡§æ‡§à ‡§µ‡§æ‡§™‡§∞‡§§‡§æ‡§®‡§æ ‡§ï‡§æ‡§≥‡§ú‡•Ä ‡§ò‡•ç‡§Ø‡§æ._
`.trim();
        return `https://wa.me/?text=${encodeURIComponent(message)}`;
    }
    // -----------------------

    // Chat logic
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const btn = document.getElementById('send');
    const cropSelect = document.getElementById('cropSelect');
    const sowingInput = document.getElementById('sowingDate');

    function addMsg(text, who) {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      
      if (who === 'bot') {
        const shareBtn = document.createElement('a');
        shareBtn.className = 'share-btn';
        shareBtn.innerHTML = '<span>üì≤ Share on WhatsApp</span>';
        shareBtn.href = createWhatsAppLink(text);
        shareBtn.target = '_blank';
        div.appendChild(document.createElement('br'));
        div.appendChild(shareBtn);
      }
      
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      addMsg(text, 'user');
      input.value = '';
      btn.disabled = true;

      const crop = cropSelect.value || null;
      const sowingDate = sowingInput.value || null;
      const payload = { message: text };
      if (crop) payload.crop = crop;
      if (sowingDate) payload.sowing_date = sowingDate;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) addMsg(data.response, 'bot');
        else addMsg('Error: ' + (data.error || 'unknown'), 'bot');
      } catch (e) {
        addMsg('Network error', 'bot');
      } finally {
        btn.disabled = false;
      }
    }
    btn.onclick = send;
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });

    // Calculator logic
    const openCalcBtn = document.getElementById('openCalcBtn');
    const closeCalcBtn = document.getElementById('closeCalcBtn');
    const calcModal = document.getElementById('calcModal');
    const calcBtn = document.getElementById('calcBtn');
    const calcOut = document.getElementById('calcOut');

    function openCalc() { calcModal.classList.add('show'); }
    function closeCalc() { calcModal.classList.remove('show'); calcOut.style.display='none'; calcOut.innerHTML=''; }

    openCalcBtn.addEventListener('click', openCalc);
    closeCalcBtn.addEventListener('click', closeCalc);
    calcModal.addEventListener('click', (e) => { if (e.target === calcModal) closeCalc(); });
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCalc(); });

    function val(id) {
      const el = document.getElementById(id);
      if (!el) return null;
      const v = el.value.trim();
      return v === '' ? null : v;
    }
    function num(v) {
      if (v === null) return null;
      const n = parseFloat(v);
      return isNaN(n) ? null : n;
    }
    function fmt(x) {
      if (x == null) return '-';
      const n = Number(x);
      if (Number.isNaN(n)) return '-';
      return n < 1 ? n.toFixed(3) : n.toFixed(2);
    }

    window.copyResult = function() {
      const text = document.getElementById('resultText').innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard.');
      });
    };

    function renderResult(data) {
      const r = data.results || {};
      const perL = r.per_liter ? `${fmt(r.per_liter.amount)} ${r.per_liter.unit}` : '-';
      const perT = r.per_tank ? `${fmt(r.per_tank.amount)} ${r.per_tank.unit}` : '-';
      const perA = r.per_acre ? `${fmt(r.per_acre.amount)} ${r.per_acre.unit}` : '-';
      const total = r.area_total ? `${fmt(r.area_total.amount)} ${(r.per_liter?.unit || r.per_acre?.unit || '')}` : '-';
      const water = r.total_water_l != null ? `${fmt(r.total_water_l)} L` : '-';
      const tanks = r.tanks_needed != null ? fmt(r.tanks_needed) : '-';

      const farmer = data.input?.farmer || '';
      const cropNote = data.input?.crop_note || '';
      const area = data.input?.area_acre ?? '-';
      const shopName = localStorage.getItem('krishiShopName') || "";

      const resultText = 
`${shopName ? 'üè™ ' + shopName : ''}
--------------------------------
‡§∂‡•á‡§§‡§ï‡§∞‡•Ä: ${farmer || '-'}
‡§´‡§∏‡§≤/‡§®‡•ã‡§ü‡•ç‡§∏: ${cropNote || '-'}

‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞: ${area} ‡§è‡§ï‡§∞
‡§â‡§§‡•ç‡§™‡§æ‡§¶: ${data.input?.product || 'N/A'}

Per Liter: ${perL}
Per Tank: ${perT}
Per Acre: ${perA}
Total (${area} acre): ${total}
‡§™‡§æ‡§£‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§ó‡§∞‡§ú: ${water}
‡§ü‡§Å‡§ï‡§ö‡•Ä ‡§ó‡§∞‡§ú: ${tanks}`;

      calcOut.innerHTML = `
        <div class="top-actions">
          <button onclick="copyResult()">Copy</button>
        </div>
        <pre id="resultText" style="font-family:monospace; white-space:pre-wrap; font-size:13px; line-height:1.5;">${resultText}</pre>
        <div class="hint" style="margin-top:8px;">
          ‚Ä¢ Always follow label (‡§π‡§Æ‡•á‡§∂‡§æ ‡§≤‡•á‡§¨‡§≤ ‡§¶‡•á‡§ñ‡•á‡§Ç)<br/>
          ‚Ä¢ PHI/REI and PPE mandatory
        </div>
      `;
      calcOut.style.display = 'block';
    }

    calcBtn.addEventListener('click', async () => {
      const product = val('c_product');
      const unit = val('c_unit');
      const rate = num(val('c_rate'));
      const tank = num(val('c_tank'));
      const spray = num(val('c_spray'));
      const area = num(val('c_area'));
      const farmer = val('c_farmer');
      const cropNote = val('c_cropnote');

      if (!unit) { alert('Please select unit (‡§á‡§ï‡§æ‡§à ‡§ö‡•Å‡§®‡•á‡§Ç)'); return; }
      if (rate == null) { alert('Please enter rate (‡§¶‡§∞ ‡§≠‡§∞‡•á‡§Ç)'); return; }

      const payload = {};
      payload.unit = unit;
      payload.rate = rate;
      if (product) payload.product = product;
      if (tank != null) payload.tank_size_l = tank;
      if (spray != null) payload.spray_volume_l_per_acre = spray;
      if (area != null) payload.area_acre = area;
      if (farmer) payload.farmer = farmer;
      if (cropNote) payload.crop_note = cropNote;

      calcBtn.disabled = true; calcBtn.textContent = 'Calculating...';
      try {
        const headers = { 'Content-Type': 'application/json' };
        const endpoint = API_KEY ? '/api/calc/dose-secure' : '/api/calc/dose';
        if (API_KEY) headers['X-API-Key'] = API_KEY;

        const res = await fetch(endpoint, { method: 'POST', headers, body: JSON.stringify(payload) });
        const raw = await res.json();
        if (!res.ok || !raw.success) throw new Error(raw.error || ('HTTP '+res.status));
        const data = raw.data;

        // attach info
        if (!data.input) data.input = {};
        if (farmer) data.input.farmer = farmer;
        if (cropNote) data.input.crop_note = cropNote;

        renderResult(data);
        
        // SAVE TO CRM
        addToHistory(farmer, product, cropNote);
        
      } catch (e) {
        calcOut.style.display = 'block';
        calcOut.innerHTML = `<span style="color:#b91c1c">Error: ${e.message || e}</span>`;
      } finally {
        calcBtn.disabled = false; calcBtn.textContent = 'Calculate (‡§ó‡§£‡§®‡§æ ‡§ï‡§∞‡•á‡§Ç)';
      }
    });

    // --- CRM / HISTORY LOGIC ---
    function addToHistory(name, product, note) {
        if (!name && !product) return; 
        
        const entry = {
            id: Date.now(),
            date: new Date().toLocaleDateString('en-IN'),
            name: name || 'Unknown Farmer',
            product: product || 'General Advice',
            note: note || ''
        };

        let history = JSON.parse(localStorage.getItem('krishiHistory') || '[]');
        history.unshift(entry);
        if (history.length > 20) history.pop();
        localStorage.setItem('krishiHistory', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('krishiHistory') || '[]');
        
        if (history.length === 0) {
            list.innerHTML = '<div style="padding:10px; text-align:center; color:#888;">No customers yet. Calculate to save.</div>';
            return;
        }

        list.innerHTML = history.map(item => `
            <div class="hist-item">
                <div class="hist-info">
                    <div class="hist-name">${item.name} <span style="font-weight:normal; color:#888; font-size:10px;">(${item.date})</span></div>
                    <div class="hist-prod">${item.product}</div>
                </div>
                <div class="hist-actions">
                    <button class="btn-icon btn-wa" onclick="sendFollowUp('${item.product}', '${item.name}')" title="Send Follow-up">
                        üì¢ Follow-up
                    </button>
                </div>
            </div>
        `).join('');
    }

    function sendFollowUp(product, name) {
        const shopName = localStorage.getItem('krishiShopName') || "Krishi Seva";
        const text = `
‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${name} ‡§ú‡•Ä! üôè
From: *${shopName}*

‡§ï‡§æ‡§π‡•Ä ‡§¶‡§ø‡§µ‡§∏‡§æ‡§Ç‡§™‡•Ç‡§∞‡•ç‡§µ‡•Ä ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä *${product}* ‡§ò‡•á‡§ä‡§® ‡§ó‡•á‡§≤‡§æ ‡§π‡•ã‡§§‡§æ‡§§.
‡§´‡§∞‡§ï ‡§™‡§°‡§≤‡§æ ‡§ï‡§æ? ‡§™‡§ø‡§ï‡§æ‡§≤‡§æ ‡§Ü‡§∞‡§æ‡§Æ ‡§Ü‡§π‡•á ‡§®‡§æ?
‡§ï‡§æ‡§π‡•Ä ‡§Ö‡§°‡§ö‡§£ ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ ‡§¶‡•Å‡§ï‡§æ‡§®‡§æ‡§§ ‡§Ø‡§æ ‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§ï‡•â‡§≤ ‡§ï‡§∞‡§æ.

-- ${shopName} Care Team
`.trim();
        const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
        window.open(url, '_blank');
    }

    function clearHistory() {
        if(confirm('Clear all customer history?')) {
            localStorage.removeItem('krishiHistory');
            renderHistory();
        }
    }
  </script>
</body>
</html>