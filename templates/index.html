<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>KrishiGPT - Retailer Pro</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <style>
    :root { --green:#16a34a; --dark-green:#14532d; --bg:#f0fdf4; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background: var(--bg); color: #1f2937; }
    .container { max-width: 900px; margin: 0 auto; padding: 12px; }
    .card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.1); border: 1px solid #e5e7eb; }
    
    /* Header */
    h1 { margin: 0; font-size: 1.5rem; color: var(--dark-green); display: flex; align-items: center; gap: 8px; }
    .sub { color: #6b7280; margin: 4px 0 16px 0; font-size: 0.9rem; }
    
    /* Retailer Branding Section */
    .retailer-section { background: #dcfce7; border: 1px solid #86efac; padding: 12px; margin-bottom: 15px; border-radius: 8px; }
    .retailer-header { display: flex; justify-content: space-between; align-items: center; }
    .retailer-title { font-weight: 700; color: var(--dark-green); font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; }
    .retailer-toggle { color: var(--green); text-decoration: none; cursor: pointer; font-size: 12px; background: none; border: none; padding: 0; font-weight: 600; }
    .retailer-form { display: none; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #86efac; }
    .retailer-form.show { display: block; }
    .retailer-display { font-size: 14px; font-weight: bold; color: #15803d; margin-top: 4px; display: flex; align-items: center; gap: 6px; }

    /* Chat Area */
    #chat { height: 50vh; overflow-y: auto; padding: 12px; border: 1px solid #e5e7eb; border-radius: 12px; background:#f9fafb; margin-bottom: 12px; scroll-behavior: smooth; }
    .msg { padding: 10px 14px; margin: 8px 0; border-radius: 12px; white-space: pre-wrap; position: relative; font-size: 14px; line-height: 1.5; max-width: 85%; }
    .user { background: #e0f2fe; color: #075985; margin-left: auto; border-bottom-right-radius: 2px; }
    .bot { background: #fff; border: 1px solid #e5e7eb; color: #1f2937; margin-right: auto; border-bottom-left-radius: 2px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    /* Share Button */
    .share-btn { 
      display: inline-flex; align-items: center; gap: 6px;
      margin-top: 8px; padding: 6px 14px; 
      background: #25D366; color: white; 
      font-size: 12px; font-weight: bold; 
      border-radius: 20px; text-decoration: none; 
      border: none; cursor: pointer; transition: background 0.2s;
    }
    .share-btn:hover { background: #1ebc57; }

    /* Inputs */
    .row { display: flex; gap: 8px; align-items: center; }
    input, select { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #d1d5db; font-size:15px; outline: none; transition: border-color 0.2s; }
    input:focus, select:focus { border-color: var(--green); outline: 2px solid var(--green); }    
    /* Buttons */
    button { padding: 12px 16px; border: 0; border-radius: 8px; background: var(--green); color:#fff; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.2s; }
    button:hover { background: #15803d; }
    button:disabled { background:#9ca3af; cursor:not-allowed; }
    button.icon-btn { padding: 12px; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    
    /* Mic Button */
    #micBtn { background: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
    #micBtn.listening { background: #fee2e2; color: #ef4444; border-color: #ef4444; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

    /* Modal */
    .modal { position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; align-items: center; justify-content: center; padding: 16px; z-index:999; backdrop-filter: blur(2px); }
    .modal.show { display:flex; }
    .box { width: 100%; max-width: 500px; background:#fff; border-radius: 16px; padding: 20px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); overflow-y:auto; max-height:90vh; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .grid .full { grid-column: 1 / -1; }
    .hint { color: #6b7280; font-size: 11px; margin-top:4px; }
    .result { background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; padding:12px; margin-top:16px; }
    .close { background: transparent; color: #6b7280; font-size: 20px; padding: 4px; }
    .close:hover { background: #f3f4f6; color: #000; }
    .footer { color:#6b7280; font-size:11px; margin-top:16px; text-align:center; }
    .hr { height:1px; background:#e5e7eb; margin: 16px 0; }
    label { font-weight:600; font-size:13px; display:block; margin-bottom:4px; color: #374151; }
    .top-actions { display:flex; gap:8px; justify-content:flex-end; margin-bottom:8px; }
    .top-actions button { padding:6px 12px; font-size:12px; }
    .btn-print { background: #3b82f6; }
    .btn-print:hover { background: #2563eb; }

    /* History */
    .hist-item { padding: 10px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between; align-items: center; }
    .hist-info { flex: 1; }
    .hist-name { font-weight: 600; color: #111827; font-size: 13px; }
    .hist-prod { color: #6b7280; font-size: 12px; }
    .btn-icon { padding: 6px 10px; font-size: 12px; border-radius: 6px; border:none; color:white; display: flex; align-items: center; gap: 4px; }
    .btn-wa { background: #25D366; }
    
    /* Crop Select Area */
    .crop-card { background: #fffbeb; border: 1px solid #fcd34d; padding: 10px; border-radius: 8px; margin-bottom: 12px; }

    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
      .container { padding: 8px; }
      .card { padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üåæ KrishiGPT <span style="font-size:10px; background:#dcfce7; color:#166534; padding:2px 6px; border-radius:99px;">PRO</span></h1>
      <p class="sub">AI Agronomy Assistant & Retailer Tools</p>

      <!-- RETAILER BRANDING -->
      <div class="retailer-section">
        <div class="retailer-header">
          <div>
            <div class="retailer-title">üè™ Shop Branding</div>
            <div id="shopDisplay" class="retailer-display">Using Default Settings</div>
          </div>
          <button class="retailer-toggle" onclick="toggleShopSettings()">‚öôÔ∏è Edit Shop Info</button>
        </div>
        
        <div id="shopSettings" class="retailer-form">
          <div class="grid" style="grid-template-columns: 1fr; gap: 8px;">
            <input type="text" id="shopNameInput" placeholder="Enter Shop Name (e.g. Patil Krishi Seva)">
            <input type="text" id="shopPhoneInput" placeholder="Mobile Number (e.g. 98220xxxxx)">
            <button onclick="saveShopDetails()">‚úÖ Save Settings</button>
          </div>
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
        <button id="openCalcBtn" style="background:#4f46e5; width:100%;">üßÆ Open Dosage Calculator</button>
      </div>

      <!-- CROP CONTEXT -->
      <div class="crop-card">
        <div style="font-size:12px; font-weight:700; color:#b45309; margin-bottom:6px; text-transform:uppercase;">
          üå± Crop Context (Optional)
        </div>
        <div style="display:flex; gap:8px;">
          <select id="cropSelect">
            <option value="">Select Crop...</option>
            <option value="grapes">üçá Grapes (‡§¶‡•ç‡§∞‡§æ‡§ï‡•ç‡§∑)</option>
            <option value="pomegranate">üçé Pomegranate (‡§°‡§æ‡§≥‡§ø‡§Ç‡§¨)</option>
            <option value="tomato">üçÖ Tomato (‡§ü‡•ã‡§Æ‡•Ö‡§ü‡•ã)</option>
            <option value="onion">üßÖ Onion (‡§ï‡§æ‡§Ç‡§¶‡§æ)</option>
            <option value="cotton">‚òÅÔ∏è Cotton (‡§ï‡§æ‡§™‡•Ç‡§∏)</option>
            <option value="soybean">üå± Soybean (‡§∏‡•ã‡§Ø‡§æ‡§¨‡•Ä‡§®)</option>
            <option value="sugarcane">üéã Sugarcane (‡§ä‡§∏)</option>
          </select>
          <input id="sowingDate" type="date" style="max-width: 130px;"/>
        </div>
      </div>

      <div id="chat"></div>
      
      <div class="row">
        <!-- Voice Input Button -->
        <button id="micBtn" class="icon-btn" onclick="toggleVoice()" title="Speak">üé§</button>
        
        <input id="msg" placeholder="Ask in Marathi/Hindi..."/>
        <button id="send" class="icon-btn" style="background:var(--green);">‚û§</button>
      </div>
      
      <div class="footer">
        ‚ö†Ô∏è Disclaimer: AI advice. Always check product label.
      </div>
    </div>
  </div>

  <!-- MODAL: DOSAGE & CRM -->
  <div id="calcModal" class="modal">
    <div class="box">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="calcTitle" style="margin:0;">üßÆ Dosage Calculator</h3>
        <button id="closeCalcBtn" class="close">‚úï</button>
      </div>
      <div class="hr"></div>

      <div class="grid">
        <div class="full">
          <label>Farmer Name (‡§∂‡•á‡§§‡§ï‡§∞‡•Ä)</label>
          <input id="c_farmer" placeholder="e.g. Ram Patil"/>
        </div>
        <div class="full">
          <label>Product Name (‡§î‡§∑‡§ß)</label>
          <input id="c_product" placeholder="e.g. Confidor"/>
        </div>
        <div>
          <label>Unit (‡§è‡§ï‡§ï)</label>
          <select id="c_unit">
            <option value="ml_per_l">ml per Litre</option>
            <option value="g_per_l">gm per Litre</option>
            <option value="ml_per_acre">ml per Acre</option>
            <option value="g_per_acre">gm per Acre</option>
          </select>
        </div>
        <div>
          <label>Rate (‡§™‡•ç‡§∞‡§Æ‡§æ‡§£)</label>
          <input id="c_rate" type="number" step="any" placeholder="0.0"/>
        </div>
        <div>
          <label>Tank Size (L)</label>
          <input id="c_tank" type="number" step="any" placeholder="15"/>
        </div>
        <div>
          <label>Area (Acre)</label>
          <input id="c_area" type="number" step="any" value="1"/>
        </div>
        <div class="full">
           <label>Spray Volume (L/Acre) <span style="font-weight:normal;color:#888;font-size:10px;">(Auto: 200)</span></label>
           <input id="c_spray" type="number" step="any" placeholder="200"/>
        </div>
        
        <div class="full">
          <button id="calcBtn" style="width:100%">Calculate Dosage</button>
        </div>

        <div class="full">
          <div id="calcOut" class="result" style="display:none;"></div>
        </div>
      </div>

      <!-- HISTORY -->
      <div class="hr"></div>
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h4 style="margin:0; font-size:13px; color:#1f2937;">üìú Customer History</h4>
        <button onclick="clearHistory()" style="font-size:10px; padding:4px 8px; background:#ef4444;">Clear All</button>
      </div>
      
      <div id="historyList" style="max-height: 150px; overflow-y: auto;">
        <!-- JS fills this -->
      </div>
    </div>
  </div>

  <script>
    const API_KEY = ""; 

    // --- 1. RETAILER BRANDING ---
    document.addEventListener('DOMContentLoaded', function() {
        const savedName = localStorage.getItem('krishiShopName');
        const savedPhone = localStorage.getItem('krishiShopPhone');
        if (savedName) {
            document.getElementById('shopNameInput').value = savedName;
            document.getElementById('shopPhoneInput').value = savedPhone || '';
            updateShopDisplay(savedName, savedPhone);
        }
        renderHistory();
        
        // Hide mic if not supported
        if (!('webkitSpeechRecognition' in window)) {
            document.getElementById('micBtn').style.display = 'none';
        }
    });

    function toggleShopSettings() {
        document.getElementById('shopSettings').classList.toggle('show');
    }

    function saveShopDetails() {
        const name = document.getElementById('shopNameInput').value.trim();
        const phone = document.getElementById('shopPhoneInput').value.trim();
        if (name) {
            localStorage.setItem('krishiShopName', name);
            localStorage.setItem('krishiShopPhone', phone);
            updateShopDisplay(name, phone);
            toggleShopSettings();
        } else {
            alert('Shop Name is required');
        }
    }

    function updateShopDisplay(name, phone) {
        document.getElementById('shopDisplay').innerHTML = `üè™ ${name} ${phone ? '<span style="color:#6b7280; font-weight:normal;">| üìû ' + phone + '</span>' : ''}`;
    }

    function createWhatsAppLink(adviceText) {
        const shopName = localStorage.getItem('krishiShopName') || "KrishiGPT Advisor";
        const shopPhone = localStorage.getItem('krishiShopPhone') || "";
        const message = `*üè™ ${shopName}*\n${shopPhone ? 'üìû ' + shopPhone + '\n' : ''}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n*Advice:*\n\n${adviceText}\n\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n‚úÖ Verified by KrishiGPT`;
        return `https://wa.me/?text=${encodeURIComponent(message)}`;
    }

    // --- 2. VOICE INPUT (New!) ---
    let recognition;
    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = 'hi-IN'; // Default Hindi/Marathi mix
        
        recognition.onstart = function() {
            document.getElementById('micBtn').classList.add('listening');
        };
        
        recognition.onend = function() {
            document.getElementById('micBtn').classList.remove('listening');
        };
        
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            document.getElementById('msg').value = transcript;
        };
    }

    function toggleVoice() {
        if (recognition) {
            recognition.start();
        } else {
            alert("Voice input not supported in this browser. Use Chrome.");
        }
    }

    // --- 3. CHAT LOGIC ---
    const chat = document.getElementById('chat');
    const input = document.getElementById('msg');
    const btn = document.getElementById('send');

    function addMsg(text, who) {
      const div = document.createElement('div');
      div.className = 'msg ' + (who === 'user' ? 'user' : 'bot');
      div.textContent = text;
      
      if (who === 'bot') {
        const shareBtn = document.createElement('a');
        shareBtn.className = 'share-btn';
        shareBtn.innerHTML = '<span>üì≤ Share</span>';
        shareBtn.href = createWhatsAppLink(text);
        shareBtn.target = '_blank';
        div.appendChild(document.createElement('br'));
        div.appendChild(shareBtn);
      }
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      addMsg(text, 'user');
      input.value = '';
      btn.disabled = true;

      const crop = document.getElementById('cropSelect').value || null;
      const sowingDate = document.getElementById('sowingDate').value || null;
      const payload = { message: text };
      if (crop) payload.crop = crop;
      if (sowingDate) payload.sowing_date = sowingDate;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.success) addMsg(data.response, 'bot');
        else addMsg('Error: ' + (data.error || 'unknown'), 'bot');
      } catch (e) {
        addMsg('Network error', 'bot');
      } finally {
        btn.disabled = false;
      }
    }
    btn.onclick = send;
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') send(); });

    // --- 4. CALCULATOR & PRINTING ---
    const calcModal = document.getElementById('calcModal');
    const calcOut = document.getElementById('calcOut');
    
    document.getElementById('openCalcBtn').onclick = () => calcModal.classList.add('show');
    document.getElementById('closeCalcBtn').onclick = () => calcModal.classList.remove('show');

    function val(id) { return document.getElementById(id).value.trim() || null; }
    function num(v) { return v ? parseFloat(v) : null; }
    function fmt(x) { return x ? Number(x).toFixed(2) : '-'; }

    // PRINT BILL FUNCTION
    function printBill(data) {
        const shopName = localStorage.getItem('krishiShopName') || "Krishi Seva";
        const w = window.open('', '', 'width=350,height=600');
        w.document.write(`
            <html><head><style>
                body { font-family: monospace; font-size: 12px; width: 300px; padding: 10px; }
                .center { text-align: center; }
                hr { border-top: 1px dashed #000; }
                .row { display: flex; justify-content: space-between; }
                .bold { font-weight: bold; }
            </style></head><body>
                <div class="center">
                    <h3 style="margin:0">${shopName}</h3>
                    <div>Dosage Receipt</div>
                    <hr>
                </div>
                <div>Customer: ${data.input.farmer || 'Walk-in'}</div>
                <div>Product: ${data.input.product || '-'}</div>
                <hr>
                <div class="row"><span>Per 15L Pump:</span> <span class="bold">${fmt(data.results.per_tank.amount)} ${data.results.per_tank.unit}</span></div>
                <div class="row"><span>Per Acre:</span> <span>${fmt(data.results.per_acre.amount)} ${data.results.per_acre.unit}</span></div>
                <div class="row"><span>Tanks Needed:</span> <span>${fmt(data.results.tanks_needed)}</span></div>
                <hr>
                <div class="center">Thank You!<br>Powered by KrishiGPT</div>
            </body></html>
        `);
        w.print();
        w.close();
    }

    document.getElementById('calcBtn').onclick = async () => {
        const product = val('c_product');
        const unit = val('c_unit');
        const rate = num(val('c_rate'));
        const tank = num(val('c_tank'));
        const spray = num(val('c_spray'));
        const area = num(val('c_area'));
        const farmer = val('c_farmer');

        if (!unit || rate == null) { alert('Unit and Rate are required'); return; }

        const payload = { unit, rate, product, tank_size_l: tank, spray_volume_l_per_acre: spray, area_acre: area };
        
        try {
            const res = await fetch('/api/calc/dose', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
            const raw = await res.json();
            const data = raw.data;
            
            // Render Result
            if(!data.input) data.input = {};
            data.input.farmer = farmer;
            data.input.product = product;

            calcOut.innerHTML = `
                <div class="top-actions">
                  <button class="btn-print" id="printBtn">üñ®Ô∏è Print Slip</button>
                </div>
                <div style="font-family:monospace; line-height:1.6;">
                  <b>Per Pump (${data.input.tank_size_l}L):</b> <span style="color:#16a34a; font-weight:bold; font-size:16px;">${fmt(data.results.per_tank.amount)} ${data.results.per_tank.unit}</span><br/>
                  <b>Per Acre:</b> ${fmt(data.results.per_acre.amount)} ${data.results.per_acre.unit}<br/>
                  <b>Total Tanks:</b> ${fmt(data.results.tanks_needed)}
                </div>
            `;
            calcOut.style.display = 'block';

            // Bind Print Button
            document.getElementById('printBtn').onclick = () => printBill(data);

            // Save to History
            addToHistory(farmer, product);

        } catch(e) {
            alert("Calculation Error: " + e.message);
        }
    };

    // --- 5. CRM HISTORY ---
    function addToHistory(name, product) {
        if (!name && !product) return;
        const entry = { id: Date.now(), date: new Date().toLocaleDateString('en-IN'), name: name || 'Guest', product: product || 'Advice' };
        let history = JSON.parse(localStorage.getItem('krishiHistory') || '[]');
        history.unshift(entry);
        if (history.length > 20) history.pop();
        localStorage.setItem('krishiHistory', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        const history = JSON.parse(localStorage.getItem('krishiHistory') || '[]');
        if (history.length === 0) { list.innerHTML = '<div style="padding:10px;text-align:center;color:#999;">No history yet</div>'; return; }
        
        list.innerHTML = history.map(item => `
            <div class="hist-item">
                <div class="hist-info"><div class="hist-name">${item.name}</div><div class="hist-prod">${item.product}</div></div>
                <button class="btn-icon btn-wa" onclick="followUp('${item.product}', '${item.name}')">üì¢ Follow-up</button>
            </div>
        `).join('');
    }

    window.followUp = (prod, name) => {
        const shop = localStorage.getItem('krishiShopName') || "Krishi Seva";
        const txt = `Namaskar ${name} ji! From: *${shop}*\n\nHow were the results of *${prod}*? Any issues?\n\n-- ${shop}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    };

    window.clearHistory = () => { if(confirm('Clear history?')) { localStorage.removeItem('krishiHistory'); renderHistory(); } };
  </script>
</body>
</html>